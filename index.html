<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>í•™ìƒ ê°œì¸ì¼ì§€ (LOG ì €ì¥ Â· ì¼ì§€ ìƒì„±)</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb" />
<style>
  :root{--bd:#e5e7eb;--bg:#f8fafc;--ink:#0f172a;--mut:#64748b;--brand:#2563eb;--ok:#059669;}
  body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Apple Color Emoji;
       background:var(--bg);color:var(--ink);margin:0}
  .wrap{max-width:1100px;margin:24px auto;background:#fff;padding:20px;border-radius:16px;box-shadow:0 4px 20px rgba(15,23,42,.06)}
  h1{margin:0 0 16px}
  h2{margin:24px 0 10px}
  .row{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  input,select,button,textarea{border:1px solid var(--bd);border-radius:10px;padding:9px 10px;font-size:14px}
  textarea{min-height:72px}
  .btn{cursor:pointer}
  .btn.b{background:var(--brand);color:#fff;border:0}
  .btn.g{background:var(--ok);color:#fff;border:0}
  .btn.o{background:#fff}
  .btns{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
  .card{border:1px solid var(--bd);border-radius:14px;padding:12px;margin:12px 0}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--bd);padding:8px;text-align:left;vertical-align:top}
  th{background:#f1f5f9}
  .small{color:var(--mut);font-size:12px}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .msg{margin:8px 0;padding:10px;border:1px solid var(--bd);border-radius:12px;background:#f8fafc;white-space:pre-wrap}
  .ok{color:var(--ok)}
  .err{color:#dc2626}
</style>

<div class="wrap">
  <h1>í•™ìƒ ê°œì¸ì¼ì§€ (PWA)</h1>

  <div class="card">
    <div class="row">
      <label>ì›¹ì•± URL (/exec)
        <input id="url" placeholder="https://script.google.com/macros/s/.../exec" />
      </label>
      <label>í•™ìƒ
        <select id="student"><option value="">ë¨¼ì € â€˜í•™ìƒ ë¶ˆëŸ¬ì˜¤ê¸°â€™</option></select>
      </label>
      <label>ë‚ ì§œ
        <input id="date" type="date" />
      </label>
      <label>ìš”ì¼
        <input id="weekday" placeholder="ì˜ˆ: ëª©ìš”ì¼" />
      </label>
      <label>ì‹œì‘ì‹œê°„
        <input id="startTime" placeholder="ì˜ˆ: 17:00" />
      </label>
    </div>
    <div class="btns">
      <button class="btn o" id="btnPing">í•‘</button>
      <button class="btn o" id="btnLoadStudents">í•™ìƒ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button class="btn o" id="btnSaveLocal">ì„ì‹œ ì €ì¥(ë¸Œë¼ìš°ì €)</button>
      <button class="btn o" id="btnLoadLocal">ì„ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <span class="small">â€» í•™ìƒ ëª©ë¡ì€ ì‹œíŠ¸ â€˜í•™ìƒëª©ë¡â€™ íƒ­ì˜ <b>name/active(note)</b>, active=Y ë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤.</span>
    </div>
    <div id="sys" class="msg"></div>
  </div>

  <h2>â‘  ìˆ˜ì—… ì¤‘ ê¸°ë¡ (LOG ì €ì¥ í¼)</h2>
  <div class="card">
    <div class="right">
      <button class="btn o" id="btnAddRow">í–‰ ì¶”ê°€</button>
      <button class="btn o" id="btnClearRows">í–‰ ëª¨ë‘ ì§€ìš°ê¸°</button>
    </div>
    <div style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>ë‹´ë‹¹ì</th>
            <th>ë¶€ë¶„</th>
            <th>ì‹œê°„</th>
            <th>ê³¼ëª©</th>
            <th>ë¬¸ì œì§‘</th>
            <th>ë‹¨ì›</th>
            <th>ê°œìˆ˜</th>
            <th>ë¹„ê³ </th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="btns">
      <button class="btn b" id="btnSaveLog">êµ¬ê¸€ì‹œíŠ¸ì— LOG ì €ì¥</button>
    </div>
    <div class="small">ì €ì¥í•˜ë©´ ì‹œíŠ¸ì˜ <b>í•™ìƒì´ë¦„_LOG</b> íƒ­ìœ¼ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.</div>
    <div id="logMsg" class="msg"></div>
  </div>

  <h2>â‘¡ ìˆ˜ì—… í›„: ì¼ì§€ ìƒì„±</h2>
  <div class="card">
    <label>ë‹¤ìŒ ì‹œê°„ ê³¼ì œ
      <textarea id="nextTask" placeholder="ë‹¤ìŒ ìˆ˜ì—…ê¹Œì§€ í•  ê³¼ì œë¥¼ ì ì–´ì£¼ì„¸ìš”."></textarea>
    </label>
    <div class="btns">
      <button class="btn g" id="btnGenerate">ğŸ“˜ ìµœì¢… ì¼ì§€ ìƒì„±</button>
    </div>
    <div class="small">ì¼ì§€ëŠ” <b>í•™ìƒì´ë¦„_ì¼ì§€</b> íƒ­ìœ¼ë¡œ ìƒˆë¡œ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤. (LOG ë‚´ìš© ê·¸ëŒ€ë¡œ í‘œë¡œ, í•˜ë‹¨ì—” â€˜ë‹¤ìŒ ì‹œê°„ ê³¼ì œâ€™ë§Œ í¬í•¨)</div>
    <div id="genMsg" class="msg"></div>
  </div>
</div>

<script>
// PWA SW ë“±ë¡
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

const HEADERS = ['ë‹´ë‹¹ì','ë¶€ë¶„','ì‹œê°„','ê³¼ëª©','ë¬¸ì œì§‘','ë‹¨ì›','ê°œìˆ˜','ë¹„ê³ '];
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);
const tbody = $('#tbl tbody');

function show(msg, where='#sys'){
  const m=document.querySelector(where);
  m.textContent = msg;
}
function rowObjFromTr(tr){
  const o = {}; HEADERS.forEach((h,i)=>{ o[h]=tr.children[i].firstChild.value || '' });
  return o;
}
function addRow(v={}){
  const tr=document.createElement('tr');
  HEADERS.forEach(h=>{
    const td=document.createElement('td');
    const inp=document.createElement('input');
    inp.value = v[h] || '';
    td.appendChild(inp); tr.appendChild(td);
  });
  const td=document.createElement('td');
  const btn=document.createElement('button'); btn.textContent='ì‚­ì œ';
  btn.onclick=()=>tr.remove(); td.appendChild(btn); tr.appendChild(td);
  tbody.appendChild(tr);
}
function clearRows(){ tbody.innerHTML=''; addRow(); }
function collectRows(){ return Array.from($$('#tbl tbody tr')).map(rowObjFromTr); }
function collectFooter(){ return { 'ë‹¤ìŒì‹œê°„ì²´í¬': $('#nextTask').value || '' }; }

function saveLocal(){
  const data={
    url:$('#url').value, student:$('#student').value,
    date:$('#date').value, weekday:$('#weekday').value, startTime:$('#startTime').value,
    rows:collectRows(), footer:collectFooter()
  };
  localStorage.setItem('daily-log', JSON.stringify(data));
  show('ì´ ë¸Œë¼ìš°ì €ì— ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}
function loadLocal(){
  try{
    const d=JSON.parse(localStorage.getItem('daily-log')||'{}');
    if(d.url) $('#url').value=d.url;
    if(d.student) $('#student').innerHTML='<option>'+d.student+'</option>';
    if(d.date) $('#date').value=d.date;
    if(d.weekday) $('#weekday').value=d.weekday;
    if(d.startTime) $('#startTime').value=d.startTime;
    clearRows(); (d.rows||[{}]).forEach(addRow);
    $('#nextTask').value = (d.footer && d.footer['ë‹¤ìŒì‹œê°„ì²´í¬']) || '';
    show('ì„ì‹œ ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ.');
  }catch(_){ clearRows(); }
}
if(!$('#tbl tbody').children.length) addRow();

$('#btnAddRow').onclick = addRow;
$('#btnClearRows').onclick = clearRows;
$('#btnSaveLocal').onclick = saveLocal;
$('#btnLoadLocal').onclick = loadLocal;

$('#btnPing').onclick = async () => {
  const url=$('#url').value.trim(); if(!url) return show('ë¨¼ì € /exec URLì„ ì…ë ¥í•˜ì„¸ìš”.');
  try{
    const r=await fetch(url+'?mode=ping');
    const j=await r.json();
    show('í•‘: '+JSON.stringify(j));
  }catch(e){ show('í•‘ ì‹¤íŒ¨: '+e); }
};
$('#btnLoadStudents').onclick = async () => {
  const url=$('#url').value.trim(); if(!url) return show('ë¨¼ì € /exec URLì„ ì…ë ¥í•˜ì„¸ìš”.');
  try{
    const r=await fetch(url+'?mode=listStudents');
    const j=await r.json();
    const arr=(j.students||[]);
    if(!arr.length) return show('í•™ìƒëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ì‹œíŠ¸ì—ì„œ name/active=Y ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
    $('#student').innerHTML = '<option value="">í•™ìƒ ì„ íƒ</option>' + arr.map(s=>`<option>${s.name}</option>`).join('');
    show(`í•™ìƒ ${arr.length}ëª… ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
  }catch(e){ show('í•™ìƒ ëª©ë¡ ìš”ì²­ ì‹¤íŒ¨: '+e); }
};

function payload(mode){
  return {
    mode, student:$('#student').value,
    date:$('#date').value, weekday:$('#weekday').value, startTime:$('#startTime').value,
    rows:collectRows(), footer:collectFooter(), savedAt:new Date().toISOString()
  };
}
async function postToWebApp(which){
  const url=$('#url').value.trim(); if(!url) return show('ì›¹ì•± URLì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.', '#logMsg');
  if(!$('#student').value) return show('í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', '#logMsg');
  if(!$('#date').value) return show('ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš”.', '#logMsg');

  const data = payload(which);
  const form = new URLSearchParams();
  Object.entries({
    mode: data.mode,
    student: data.student,
    date: data.date,
    weekday: data.weekday,
    startTime: data.startTime,
    rows: JSON.stringify(data.rows),
    footer: JSON.stringify(data.footer),
    savedAt: data.savedAt
  }).forEach(([k,v])=> form.append(k, v ?? ''));

  try{
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body: form.toString()
    });
    const j = await res.json().catch(()=> ({}));
    const msg = (which==='log'?'LOG':'ì¼ì§€')+' ì €ì¥ ìš”ì²­ ì™„ë£Œ! '+(j.ok?'ok':'');
    if(which==='log') show(msg, '#logMsg'); else show(msg, '#genMsg');
  }catch(e){
    if(which==='log') show('ì „ì†¡ ì‹¤íŒ¨: '+e, '#logMsg'); else show('ì „ì†¡ ì‹¤íŒ¨: '+e, '#genMsg');
  }
}
$('#btnSaveLog').onclick = ()=> postToWebApp('log');
$('#btnGenerate').onclick = ()=> postToWebApp('generate');
</script>
</html>
